# TODO: helpers besser filtern. z.B. fÃ¼r einen lux sensor nicht einfach alle input_numbers, sondern nur die relevanten.

#  Was soll unterstÃ¼tzt werden?
# Tag/Nacht-Steuerung (Sichtschutz)
# - Storen automatisch hoch/runter bei sonnenauf-/untergang (Sichtschutz)
# - Alternativ basierend auf Zeitplan steuern statt sonnenstand
# - alternativ basierend auf helligkeitssensor steuern (ein select input mit sonnenstand/zeitplan/helligkeit)
# Rahmenbedingungen
# - Bei Steuerung via Sensorwerte eine VerzÃ¶gerung einbauen, dass sie nicht stÃ¤ndig wechseln, wenn z.B. eine Wolke vor der Sonne steht
# - MÃ¶glichkeit um offset und grenzwerte via helper im frontend zu setzen, ansonsten wird wert aus automatisierung genommen
# - Zeiten definieren wo Storen nicht frÃ¼her Ã¶ffnen dÃ¼rfen (z.B. nicht vor 6 Uhr auch wenn Sonne schon da) -> in diesem Fall um diese Zeit dann triggern
# - spÃ¤tester Zeitpunkt wann storen aufgehen sollen, auch wenn Automatisierung noch nicht getriggert hat
# - Unterscheidung Wochentage/Werktage
# - nicht herunterfahren wenn in der nÃ¤chsten halben Stunde Wind/Regen/Hagel erwartet wird
# - nicht herunterfahren, wenn es aktuell regnet / stÃ¼rmt (entweder via weather entitity, falls verfÃ¼gbar aber via sensor)
# - helper auf on stellen wenn letzte Storensteuerung von dieser (oder einer) Automatisierung gekommen ist? gewisse Aktionen nur ausfÃ¼hren, wenn der Helper auf on steht oder der letzte Change >1h her ist.
# - Additional conditions unterscheidung nach Ã¶ffnen/schliessen
# - additional actions Ã¶ffnen/schliessen
# - additioanl triggers Ã¶ffnen/schliessen

# alle gegebenen covers "auslisten" falls es gruppen hat. dann durch diese durch loopen und aktionen durchfÃ¼hren, falls z.B. eine noch manuell bewegt wurde und jetzt nicht verÃ¤ndert werden soll.

# siehe auch blueprint in sandbox: https://github.com/hvorragend/ha-blueprints/blob/main/blueprints/automation/cover_control_automation.yaml

blueprint:
  ############
  # Metadata #
  ############
  name: smarli. Cover Control Sunrise and Sunset
  description: >
    # ðŸŒž smarli. Cover Control Sunrise and Sunset

    Control covers based on the times of sunrise and sunset

    *Version 1.0.0 | 2025-04-23*

    <details>
    <summary><b>How to set it up</b></summary>

      1. Set up the required helpers:
        - input_boolean.cover_automation_tracker
      2. Here add a couple of steps that need to be followed when setting up the automation based on this blueprint.
    </details>


    All input fields are required unless they are marked as ` (optional) `.
  domain: automation
  author: loocd [smarli. AG]
  source_url: https://github.com/smarli-AG/smarli-blueprints/blob/main/automation/coversDayNight.yaml
  homeassistant:
    min_version: 2024.10.0

  ###############
  # User Inputs #
  ###############
  input:
    trigger_inputs:
      name: Trigger Inputs
      icon: mdi:star-box-multiple
      description: |
        These inputs are used to set the automation triggers

      input:
        should_suspend_after_manual_interaction:
          name: Suspend After Manual Interaction (optional)
          description: If covers are controlled manually, suspend this automation for a specified amount of time (see `Suspension Duration`).
          selector:
            boolean:
          default: true
        suspension_duration:
          name: Suspension Duration (optional)
          description: If suspension after manual interaction is turned on, this setting specifies how long the suspension should last.
          selector:
            duration:
          default:
            hours: 1
            minutes: 0
            seconds: 0
        was_triggered_by_automation_helper:
          name: Automation Tracker Helper (optional)
          description: >
            Select the helper that tracks whether the automation is running or not. Only required if suspension after manual control is active.
          selector:
            entity:
              filter:
                - integration: input_boolean
          default: input_boolean.cover_automation_tracker
        is_suspension_active_helper:
          name: Suspension Tracker (optional)
          description: Select the helper that tracks whether a suspension is active or not. Only required if suspension after manual control is active.
          selector:
            entity:
              filter:
                - integration: input_boolean
          default: input_boolean.cover_automation_suspension

        daynight_cycle_method:
          name: Day-Night Cycle Method
          description: Based on which method should the day-night cycle (opening covers in the morning, closing them at night) operate?
          selector:
            select:
              options:
                - label: Sunrise/Sunset
                  value: sun
                - label: Time
                  value: time
                - label: Brightness
                  value: brightness
          default: sun

        sunrise_offset:
          name: Sunrise Offset (optional)
          description: If required, offset the sunrise trigger from the actual sunrise time. Time of sunrise is delivered by the sun integration.
          selector:
            number:
              min: -120
              max: 120
              unit_of_measurement: minutes
          default: 0

        sunrise_offset_helper:
          name: Sunrise Offset Helper (optional)
          description: Instead of setting a sunrise offset within this automation, you can use a number helper to set the sunrise offset.
          selector:
            entity:
              domain: input_number
          default: ""

        sunset_offset:
          name: Sunset Offset (optional)
          description: If required, offset the sunset trigger from the actual sunset time. Time of sunset is delivered by the sun integration.
          selector:
            number:
              min: -120
              max: 120
              unit_of_measurement: minutes
          default: 0

        sunset_offset_helper:
          name: Sunset Offset Helper (optional)
          description: Instead of setting a sunset offset within this automation, you can use a number helper to set the sunset offset.
          selector:
            entity:
              domain: input_number
          default: ""

        time_open:
          name: Open Time (optional)
          description: Time to open covers, if `Day-Night Cycle Method` is set to `Time`.
          selector:
            time:
          default: "06:00:00"

        time_open_helper:
          name: Open Time Helper (optional)
          description: Instead of setting the opening time within this automation, you can use a datetime helper to set the open time.
          selector:
            entity:
              domain: input_datetime
          default: ""

        time_close:
          name: Close Time (optional)
          description: Time to close covers, if `Day-Night Cycle Method` is set to `Time`.
          selector:
            time:
          default: "21:00:00"

        time_close_helper:
          name: Close Time Helper (optional)
          description: Instead of setting the closing time within this automation, you can use a datetime helper to set the close time.
          selector:
            entity:
              domain: input_datetime
          default: ""

        brightness_sensor:
          name: Brightness Sensor
          description: Brightness sensor entity.
          selector:
            entity:
              domain: sensor
              device_class: illuminance
        lux_sensor_delay:
          name: Brightness Sensor Stabilizer (optional)
          description: How long does the brightness sensor need to be above the defined threshold before triggering the automation? This can be done to avoid frequent back-and-forth switching (e.g. if a cloud passes in front of the sun).
          selector:
            duration:
          default:
            hours: 0
            minutes: 5
            seconds: 0

        brightness_open:
          name: Brightness to Open (optional)
          description: Brightness level to open covers, if `Day-Night Cycle Method` is set to `Brightness`.
          selector:
            number:
              min: 0
              max: 100000
              unit_of_measurement: lux
              mode: box
          default: 500

        brightness_open_helper:
          name: Brightness Open Helper (optional)
          description: Instead of setting the brightness to open within this automation, you can use a number helper to set the brightness to open.
          selector:
            entity:
              domain: input_number
          default: ""

        brightness_close:
          name: Brightness to Close (optional)
          description: Brightness level to close covers, if `Day-Night Cycle Method` is set to `Brightness`.
          selector:
            number:
              min: 0
              max: 100000
              unit_of_measurement: lux
              mode: box
          default: 3500

        brightness_close_helper:
          name: Brightness Close Helper (optional)
          description: Instead of setting the brightness to close within this automation, you can use a number helper to set the brightness to close.
          selector:
            entity:
              domain: input_number
          default: ""

        should_use_latest_open:
          name: Use Latest Open Time
          description: Do you want to set a time at which the covers should open at the latest, if they have not been opened before?
          selector:
            boolean:
          default: false
        latest_open_workday:
          name: Latest Open Time on Workdays (optional)
          description: Latest time to open covers on workdays. Only relevant if `Use Latest Open Time` is set to `true`.
          selector:
            time:
          default: "07:00:00"
        latest_open_workday_helper:
          name: Latest Open Time Workday Helper (optional)
          description: Instead of setting the latest open time on workdays within this automation, you can use a datetime helper to set the latest open time on workdays.
          selector:
            entity:
              domain: input_datetime
          default: ""
        latest_open_non_workday:
          name: Latest Open Time on Non-Workdays (optional)
          description: Latest time to open covers on non-workdays. Only relevant if `Use Latest Open Time` is set to `true`.
          selector:
            time:
          default: "09:00:00"
        latest_open_non_workday_helper:
          name: Latest Open Time Non-Workday Helper (optional)
          description: Instead of setting the latest open time on non-workdays within this automation, you can use a datetime helper to set the latest open time on non-workdays.
          selector:
            entity:
              domain: input_datetime
          default: ""

        should_use_latest_close:
          name: Use Latest Close Time
          description: Do you want to set a time at which the covers should close at the latest, if they have not been closed before?
          selector:
            boolean:
          default: false

        latest_close_workday_tomorrow:
          name: Latest Close Time if Tomorrow is a Workday (optional)
          description: Latest time to close covers on workdays. Only relevant if `Use Latest Close Time` is set to `true`.
          selector:
            time:
          default: "22:00:00"
        latest_close_workday_tomorrow_helper:
          name: Latest Close Time Workday Helper (optional)
          description: Instead of setting the latest close time on workdays within this automation, you can use a datetime helper to set the latest close time on workdays.
          selector:
            entity:
              domain: input_datetime
          default: ""
        latest_close_non_workday_tomorrow:
          name: Latest Close Time if Tomorrow is a Non-Workday (optional)
          description: Latest time to close covers on non-workdays. Only relevant if `Use Latest Close Time` is set to `true`.
          selector:
            time:
          default: "23:00:00"
        latest_close_non_workday_tomorrow_helper:
          name: Latest Close Time Non-Workday Helper (optional)
          description: Instead of setting the latest close time on non-workdays within this automation, you can use a datetime helper to set the latest close time on non-workdays.
          selector:
            entity:
              domain: input_datetime
          default: ""

        weather_entity:
          name: Weather Entity (optional)
          description: The weather entity to check in order to block the closing of the covers.
          selector:
            entity:
              domain: weather
          default: ""
        wind_sensor:
          name: Wind Sensor (optional)
          description: If available, specify a separate wind sensor to be used to track current wind speeds.
          selector:
            entity:
              domain: sensor
              device_class: wind_speed
          default: ""
        rain_sensor:
          name: Rain Sensor (optional)
          description: If available, specify a separate moisture sensor to be used to track if it's currently raining.
          selector:
            entity:
              domain: binary_sensor
              device_class: moisture
          default: ""
        weather_events:
          name: Weather Events to Prevent Closing (optional)
          description: Which weather events should prevent the covers from closing?
          selector:
            select:
              multiple: true
              options:
                - label: High Wind Speeds
                  value: "windy"
                - label: Rainy
                  value: "rainy"
                - label: Pouring
                  value: "pouring"
                - label: Lightning
                  value: "lightning"
                - label: Lightning, rainy
                  value: "lightning-rainy"
                - label: Hail
                  value: "hail"
                - label: Snowy
                  value: "snowy"
                - label: Snowy, rainy
                  value: "snowy-rainy"
                - label: Fog
                  value: "fog"
        wind_speed_threshold:
          name: Wind Speed Threshold to Prevent Closing (optional)
          description: At what wind speed should the covers be prevented from closing?
          selector:
            number:
              min: 0
              max: 100
              unit_of_measurement: km/h
          default: 35
        wind_speed_threshold_helper:
          name: Wind Speed Threshold Helper (optional)
          description: Instead of setting the wind speed threshold within this automation, you can use a number helper to set the wind speed threshold.
          selector:
            entity:
              domain: input_number
          default: ""

    condition_inputs:
      name: Condition Inputs
      icon: mdi:help-box-multiple
      description: These inputs are used to set the automation conditions
      input:
        time_from:
          name: Automation Start Time
          description: Time from which the automation is allowed to run.
          default: "00:00:00"
          selector:
            time:

        time_from_helper:
          name: Automation Start Time Helper
          description: Helper entity to override the automation start time.
          default: ""
          selector:
            entity:
              domain: input_datetime

        time_to:
          name: Automation End Time
          description: Time until which the automation is allowed to run.
          default: "23:59:59"
          selector:
            time:

        time_to_helper:
          name: Automation End Time Helper
          description: Helper entity to override the automation end time.
          default: ""
          selector:
            entity:
              domain: input_datetime

    action_inputs:
      name: Action Inputs
      icon: mdi:play-box-multiple
      description: These inputs are used to set the actions
      input:
        cover_entity:
          name: Cover
          description: The cover entities to automate. Please beware that covers might close while people are outside (balcony/garden). It is advised to leave certain covers open to ensure nobody gets locked out.
          selector:
            entity:
              domain: cover

        manual_interaction_helper:
          name: Manual Interaction Helper
          description: Helper entity to track manual interactions.
          default: input_boolean.manual_interaction
          selector:
            entity:
              domain: input_boolean

        manual_interaction_timer:
          name: Manual Interaction Timer
          description: Timer to pause climate actions after manual interaction.
          default: timer.manual_interaction_pause
          selector:
            entity:
              domain: timer

variables:
  day_night_cycle_method: !input day_night_cycle_method
  sunrise_offset: >
    {% if sunrise_offset_helper != "" %}
      {{ states(sunrise_offset_helper) | int }}
    {% else %}
      {{ sunrise_offset }}
    {% endif %}
  sunset_offset: >
    {% if sunset_offset_helper != "" %}
      {{ states(sunset_offset_helper) | int }}
    {% else %}
      {{ sunset_offset }}
    {% endif %}
  time_open: >
    {% if time_open_helper != "" %}
      {{ states(time_open_helper) }}
    {% else %}
      {{ time_open }}
    {% endif %}
  time_close: >
    {% if time_close_helper != "" %}
      {{ states(time_close_helper) }}
    {% else %}
      {{ time_close }}
    {% endif %}
  brightness_open: >
    {% if brightness_open_helper != "" %}
      {{ states(brightness_open_helper) | int }}
    {% else %}
      {{ brightness_open }}
    {% endif %}
  brightness_close: >
    {% if brightness_close_helper != "" %}
      {{ states(brightness_close_helper) | int }}
    {% else %}
      {{ brightness_close }}
    {% endif %}
  brightness_sensor: !input brightness_sensor
  latest_open_workday: >
    {% if latest_open_workday_helper != "" %}
      {{ states(latest_open_workday_helper) }}
    {% else %}
      {{ latest_open_workday }}
    {% endif %}
  latest_close_workday_tomorrow: >
    {% if latest_close_workday_tomorrow_helper != "" %}
      {{ states(latest_close_workday_tomorrow_helper) }}
    {% else %}
      {{ latest_close_workday_tomorrow }}
    {% endif %}
  latest_open_non_workday: >
    {% if latest_open_non_workday_helper != "" %}
      {{ states(latest_open_non_workday_helper) }}
    {% else %}
      {{ latest_open_non_workday }}
    {% endif %}
  latest_close_non_workday_tomorrow: >
    {% if latest_close_non_workday_tomorrow_helper != "" %}
      {{ states(latest_close_non_workday_tomorrow_helper) }}
    {% else %}
      {{ latest_close_non_workday_tomorrow }}
    {% endif %}
  differentiate_workdays: !input differentiate_workdays
  time_from: >
    {% if time_from_helper != "" %}
      {{ states(time_from_helper) }}
    {% else %}
      {{ time_from }}
    {% endif %}
  time_to: >
    {% if time_to_helper != "" %}
      {{ states(time_to_helper) }}
    {% else %}
      {{ time_to }}
    {% endif %}

  weather_events: !input weather_events
  wind_speed_threshold: >
    {% if wind_speed_threshold_helper != "" %}
      {{ states(wind_speed_threshold_helper) | float }}
    {% else %}
      {{ wind_speed_threshold }}
    {% endif %}
  weather_entity: !input weather_entity
  manual_interaction_helper: !input manual_interaction_helper
  manual_interaction_timer: !input manual_interaction_timer

trigger:
  - platform: time
    at: "{{ time_open }}"
    id: time_open
  - platform: time
    at: "{{ time_close }}"
    id: time_close
  - platform: sun
    event: sunrise
    offset: "{{ sunrise_offset }}"
    id: sun_open
  - platform: sun
    event: sunset
    offset: "{{ sunset_offset }}"
    id: sun_close
  - platform: numeric_state
    entity_id: !input brightness_sensor
    above: "{{ brightness_open }}"
    id: brightness_open
  - platform: numeric_state
    entity_id: !input brightness_sensor
    below: "{{ brightness_close }}"
    id: brightness_close
  - platform: time
    at: "{{ latest_open_workday }}"
    id: latest_open_workday
  - platform: time
    at: "{{ latest_close_workday_tomorrow }}"
    id: latest_close_workday_tomorrow
  - platform: time
    at: "{{ latest_open_non_workday }}"
    id: latest_open_non_workday
  - platform: time
    at: "{{ latest_close_non_workday_tomorrow }}"
    id: latest_close_non_workday_tomorrow
  - platform: state
    entity_id: !input weather_entity
    to: "hail"
    id: weather_hail
  - platform: state
    entity_id: !input weather_entity
    to: "rainy"
    id: weather_rain
  - platform: numeric_state
    entity_id: !input weather_entity
    attribute: wind_speed
    above: "{{ wind_speed_threshold }}"
    id: weather_wind
  - platform: event
    event_type: state_changed
    event_data:
      entity_id: !input cover_entity
    id: manual_interaction

condition:
  - condition: time
    after: "{{ time_from }}"
    before: "{{ time_to }}"
  - condition: template
    value_template: "{{ not is_state(manual_interaction_timer, 'active') }}"

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ day_night_cycle_method == 'sun' }}"
          - condition: or
            conditions:
              - condition: trigger
                id: sun_open
              - condition: trigger
                id: sun_close
        sequence:
          - service: cover.open_cover
            target:
              entity_id: !input cover_entity
            data: {}

      - conditions:
          - condition: template
            value_template: "{{ day_night_cycle_method == 'time' }}"
          - condition: or
            conditions:
              - condition: trigger
                id: time_open
              - condition: trigger
                id: time_close
        sequence:
          - service: cover.open_cover
            target:
              entity_id: !input cover_entity
            data: {}

      - conditions:
          - condition: template
            value_template: "{{ day_night_cycle_method == 'brightness' }}"
          - condition: or
            conditions:
              - condition: trigger
                id: brightness_open
              - condition: trigger
                id: brightness_close
        sequence:
          - service: cover.open_cover
            target:
              entity_id: !input cover_entity
            data: {}

      - conditions:
          - condition: template
            value_template: "{{ differentiate_workdays }}"
          - condition: or
            conditions:
              - condition: trigger
                id: latest_open_workday
              - condition: trigger
                id: latest_close_workday_tomorrow
              - condition: trigger
                id: latest_open_non_workday
              - condition: trigger
                id: latest_close_non_workday_tomorrow
        sequence:
          - service: cover.open_cover
            target:
              entity_id: !input cover_entity
            data: {}
      - conditions:
          - condition: or
            conditions:
              - condition: trigger
                id: weather_hail
              - condition: trigger
                id: weather_rain
              - condition: trigger
                id: weather_wind
        sequence:
          - service: cover.open_cover
            target:
              entity_id: !input cover_entity
            data: {}

      - conditions:
          - condition: template
            value_template: "{{ trigger.event.origin == 'LOCAL' }}"
          - condition: trigger
            id: manual_interaction
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: !input manual_interaction_helper
            data: {}
          - service: timer.start
            target:
              entity_id: !input manual_interaction_timer
            data:
              duration: "01:00:00"
          - wait_template: "{{ is_state(manual_interaction_timer, 'active') }}"
            timeout: "01:00:00"
          - service: input_boolean.turn_off
            target:
              entity_id: !input manual_interaction_helper
            data: {}

mode: single
